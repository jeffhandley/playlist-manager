name: Validate Playlist URLs

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Validate and correct URLs
        id: validate
        env:
          APPLE_MUSIC_TEAM_ID: ${{ secrets.APPLE_MUSIC_TEAM_ID }}
          APPLE_MUSIC_KEY_ID: ${{ secrets.APPLE_MUSIC_KEY_ID }}
          APPLE_MUSIC_PRIVATE_KEY: ${{ secrets.APPLE_MUSIC_PRIVATE_KEY }}
          APPLE_MUSIC_USER_TOKEN: ${{ secrets.APPLE_MUSIC_USER_TOKEN }}
        run: |
          # Run validation (exits with code 1 if changes were made)
          if node .github/skills/apple-music-api/validate-urls.mjs; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            echo "No invalid URLs found - all playlists are valid!"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
            echo "Invalid URLs found and corrected"
          fi

      - name: Create Pull Request
        if: steps.validate.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'Fix stale Apple Music URLs'
          branch: validate-urls/auto-fix
          delete-branch: true
          title: 'Fix stale Apple Music URLs'
          body: |
            This PR was automatically generated by the playlist URL validation workflow.
            
            The validation script checked all Apple Music permalinks across all playlists and found some invalid or stale URLs. It has corrected them by:
            
            1. Verifying each song ID via the Apple Music API
            2. Searching for the correct ID when invalid
            3. Updating the permalink or removing the link if the track is not found
            
            **Please review the changes before merging.**
            
            ---
            *Automated by [validate-urls.yml](.github/workflows/validate-urls.yml)*
          labels: |
            automated
            url-validation
