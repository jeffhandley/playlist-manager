name: Validate Playlist URLs

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Validate all playlist URLs
        id: validate
        env:
          APPLE_MUSIC_TEAM_ID: ${{ secrets.APPLE_MUSIC_TEAM_ID }}
          APPLE_MUSIC_KEY_ID: ${{ secrets.APPLE_MUSIC_KEY_ID }}
          APPLE_MUSIC_PRIVATE_KEY: ${{ secrets.APPLE_MUSIC_PRIVATE_KEY }}
          APPLE_MUSIC_USER_TOKEN: ${{ secrets.APPLE_MUSIC_USER_TOKEN }}
        run: |
          # The validate-urls script exits with code 1 if changes were made
          if node .github/skills/apple-music-api/validate-urls.mjs; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "All playlist URLs are valid!"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Invalid URLs found and corrected"
          fi

      - name: Create Pull Request
        if: steps.validate.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Fix invalid Apple Music URLs'
          title: 'Fix invalid Apple Music URLs'
          body: |
            ## Automated URL Validation

            This PR was created by the **Validate Playlist URLs** workflow.

            The validation script checked all Apple Music permalinks across playlists and found some invalid or stale song IDs. This PR contains the automatic corrections:

            - **Corrected URLs** — The script searched for the correct song ID and updated the link
            - **Removed URLs** — If a track couldn't be found in Apple Music, the broken link was removed (song title remains as plain text)

            ### Next Steps

            1. Review the changes to ensure they look correct
            2. Merge this PR to trigger an automatic sync to Apple Music

            ---
            *Generated by `.github/workflows/validate-urls.yml`*
          branch: validate-urls-fixes
          delete-branch: true
