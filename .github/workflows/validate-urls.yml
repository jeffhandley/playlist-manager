name: Validate Playlist URLs

on:
  workflow_dispatch:
    inputs:
      exclude_playlists:
        description: 'Comma-separated list of playlist filenames to exclude (e.g., "90s-alternative-rock.md,hardcovers.md")'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Validate Apple Music URLs
        id: validate
        env:
          APPLE_MUSIC_TEAM_ID: ${{ secrets.APPLE_MUSIC_TEAM_ID }}
          APPLE_MUSIC_KEY_ID: ${{ secrets.APPLE_MUSIC_KEY_ID }}
          APPLE_MUSIC_PRIVATE_KEY: ${{ secrets.APPLE_MUSIC_PRIVATE_KEY }}
          APPLE_MUSIC_USER_TOKEN: ${{ secrets.APPLE_MUSIC_USER_TOKEN }}
          EXCLUDE_PLAYLISTS: ${{ inputs.exclude_playlists }}
        run: |
          # Build list of playlists to validate
          if [ -z "$EXCLUDE_PLAYLISTS" ]; then
            # No exclusions - validate all playlists
            node .github/skills/apple-music-api/validate-urls.mjs 2>&1 | tee validation.log
          else
            # Get all playlists and filter out excluded ones
            # Using arrays for safe handling of filenames with spaces
            mapfile -t all_playlists < <(find playlists -name "*.md" -type f | sort)
            playlists=()
            
            # Parse exclusions into array (IFS is localized to this read operation)
            IFS=',' read -ra exclude_list <<< "$EXCLUDE_PLAYLISTS"
            
            for playlist_file in "${all_playlists[@]}"; do
              excluded=false
              filename=$(basename "$playlist_file")
              
              # Use bash built-in string matching for efficiency
              # Match against basename for exact filename comparison
              for exclude_item in "${exclude_list[@]}"; do
                # Trim whitespace from exclude_item
                exclude_name=$(echo "$exclude_item" | xargs)
                if [[ "$filename" == "$exclude_name" ]]; then
                  excluded=true
                  break
                fi
              done
              
              if [ "$excluded" = false ]; then
                playlists+=("$playlist_file")
              fi
            done
            
            # Run validation on filtered list
            if [ ${#playlists[@]} -gt 0 ]; then
              node .github/skills/apple-music-api/validate-urls.mjs "${playlists[@]}" 2>&1 | tee validation.log
            else
              echo "No playlists to validate after exclusions"
              exit 0
            fi
          fi
          
          exit_code=${PIPESTATUS[0]}
          echo "has_changes=$( [ $exit_code -eq 1 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          # Exit 2 = error, exit 1 = corrections made, exit 0 = all valid
          if [ $exit_code -eq 2 ]; then exit 1; fi

      - name: Create PR with corrections
        if: steps.validate.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXCLUDE_PLAYLISTS: ${{ inputs.exclude_playlists }}
        run: |
          branch="fix/validate-playlist-urls-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$branch"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add playlists/
          git commit -m "Fix invalid Apple Music URLs

          Automated validation found and corrected stale or broken song IDs.
          See the workflow run for details.

          Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          git push origin "$branch"
          
          # Build PR body with optional exclusions line
          pr_body="## Automated URL Validation

          This PR was created by the **Validate Playlist URLs** workflow.

          The Apple Music API was used to verify every song permalink across all playlists. Invalid or stale song IDs were corrected by searching the Apple Music catalog for the correct track."
          
          if [ -n "$EXCLUDE_PLAYLISTS" ]; then
            pr_body="$pr_body

          **Excluded playlists:** $EXCLUDE_PLAYLISTS"
          fi
          
          pr_body="$pr_body

          ### Validation Log
          \`\`\`
          $(tail -30 validation.log)
          \`\`\`

          Review the changes to confirm the corrected URLs are accurate, then merge to trigger an automatic sync."
          
          gh pr create \
            --title "Fix invalid Apple Music URLs" \
            --body "$pr_body" \
            --base main \
            --head "$branch"
